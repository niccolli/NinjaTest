<!DOCTYPE html>
<html lang="ja">
	<head>
		<title>RealTime - FakeScope</title>
		<meta charset="UTF-8" />
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
	</head>
	<body>
		<div class="page-header">
			<h1>RealTime</h1>
		</div>
		<div class="container-fluid">
			<div class="row">
				<div id="graphDiv" class="span8" style="height: 400px;"></div>
				<div class="span4">
					<h2>About</h2>
					<a href="http://www.flickr.com/photos/36571434@N03/6880945602/" title="IMG_0940 by Yusuke ********, on Flickr"><img src="http://farm8.staticflickr.com/7248/6880945602_0ecf132f80_n.jpg" width="320" height="240" alt="IMG_0940"></a>
					<p>Streaming the vibration wave of sound from iPhone. For more details, please read <a href="http://log.niccol.li/2012/03/eventmachinehtml5.html">http://log.niccol.li/2012/03/eventmachinehtml5.html</a> or <a href="http://log.niccol.li/2012/03/blog-post.html">http://log.niccol.li/2012/03/blog-post.html</a>.</p>
					<div id="datasource" class="alert alert-error" style="display:none;">
						<h4 class="alert-heading">Stopped</h4>
						Data source is not working.
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript" src="flotr2.js"></script>
		<script type="text/javascript">
			// Display
			oscillo = [];
			MAX_OCL = 200;
			reloadTimerId = null;
			reloadSpeed = 100;  // msec
			
			// Saving
			savePointsData = [];
			MAX_SAVE_POINTS = 1000;
			saveState = false;

			// WebSocketサーバに接続
			var browse = io.connect('/browse');
			browse.on('notify' function(data){
				//deviceの個数
				if(data.device){
					$('#datasource').show();
				} else {
					$('#datasource').hide();
				}
			});

			browse.on('push', function(data){
				var point = data.split(",");
				oscillo.push([point[0], point[1]]);
				if(saveState){
					savePointsData.push([point[0], point[1]]);
					// 割合
					var wariai = Math.floor(savePointsData.length / MAX_SAVE_POINTS*100);
					$(".bar").width(wariai+"\%");
					if(savePointsData.length > MAX_SAVE_POINTS){
						saveState = false;
						$("#recording").button('toggle');
					}
				}
				if(oscillo.length > MAX_OCL){
					oscillo.shift();
				}
			});

			var graph;
			var container = document.getElementById("graphDiv");

			// Draw Graph
			function drawGraph(){
				graph = Flotr.draw(container, [ oscillo ], {
					xaxis: {
						minorTickFreq: 4
					}, 
					yaxis: {
						max: 1000,
						min: 0
					},
					grid: {
						minorVerticalLines: true
					}
				});
			}

			function redraw(){
				if(reloadTimerId){
					// タイマー設定済み
					clearInterval(reloadTimerId);
					reloadTimerId = null;
					ws.close();
					$("#streamCtrl").button('toggle');
					//$("#serverName").text("None");
					//$("#serverConn").text("False");
					//$("#interval").text("-");
				} else {
					//ws = new WebSocket(wsServer);
					reloadTimerId = setInterval(function(){
						drawGraph();
						}, reloadSpeed);
					$("#streamCtrl").button('toggle');
					//$("#serverName").text(wsServer);
					//$("#serverConn").text("True");
					//$("#interval").text(reloadSpeed+"ms");
				}
			}
			redraw();
			$("#streamCtrl").click(redraw);

			// Pushed "Recording" Button
			$("#recording").click(function(){
				if(!saveState && reloadTimerId){
					$("#recording").button('toggle');
					savePointsData = [];
					saveState = true;
					$(".bar").width("0%");
				}else if(saveState && reloadTimerId){
					saveState = false;
					$("#recording").button('toggle');
				}
			});
		</script>
	</body>
</html>

